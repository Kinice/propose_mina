<template>
  <div class="container">
    <div class="title">{{puzzleList[nowStatus - 1].title}}</div>
    <div class="description">{{puzzleList[nowStatus - 1].description}}</div>
    <div class="description">
      <button class="cu-btn bg-olive" @tap="imHere">æˆ‘åˆ°äº†</button>
    </div>
    <div class="description" v-if="showWrong">
      <button class="cu-btn bg-olive" @tap="imWrong">åƒåœ¾ç¨‹åºå‘˜ï¼Œæˆ‘æ˜æ˜åˆ°äº†</button>
    </div>
  </div>
</template>
<script>
  import wepy from '@wepy/core'
  wepy.page({
    data: {
      nowStatus: 1,
      puzzleList: [{
        title: 'Puzzle 1',
        description: 'é»„æµ·ä¹‹æ»¨ï¼Œä»¥äººä¸ºåï¼Œè™½å±…æµ·æ»¨ï¼Œä¸å¸¸è¸è¶³',
        location: {
          latitude: 37.4797538329,
          longitude: 121.4609599113
        },
        name: 'äºç»´å¼˜å­¦æœ¯äº¤æµä¸­å¿ƒ'
      }, {
        title: 'Puzzle 2',
        description: 'åˆè¿›æ‘é‡Œï¼Œå°½ä¸ºæµ·é£æŠ˜è…°',
        location: {
          latitude: 37.4779573435,
          longitude: 121.4598977566
        },
        name: 'å°æ ‘æ—'
      }, {
        title: 'Puzzle 3',
        description: '2Ï€r=400mçš„ä¸­å¤®',
        location: {
          latitude: 37.4765993051,
          longitude: 121.4614534378
        },
        name: 'ä½“è‚²åœº'
      }, {
        title: 'Puzzle 4',
        description: 'é¤é¥®å¨±ä¹æ´—æµ´ç”Ÿæ´»ä¸­å¿ƒ',
        location: {
          latitude: 37.4731210817,
          longitude: 121.4621776342
        },
        name: 'ç¬¬ä¸ƒé¤å…'
      }, {
        title: 'Puzzle 5',
        description: 'ä¸­è½´çº¿ä¸­ï¼Œç©¹é¡¶ä¹‹ä¸‹',
        location: {
          latitude: 37.4720354341,
          longitude: 121.4577680826
        },
        name: 'ç»¼åˆæ¥¼å¤§é—¨'
      }, {
        title: 'Puzzle 6',
        description: 'è°äººé™ç™½è›‡',
        location: {
          latitude: 37.4708220446,
          longitude: 121.4559227228
        },
        name: 'æ³•å­¦é™¢ä¸æµ·æ´‹å­¦é™¢'
      }, {
        title: 'Puzzle 7',
        description: 'ä¸€ä¸ªæ°¸è¿œè¢«å«é”™åå­—çš„äº¤é€šè®¾æ–½',
        location: {
          latitude: 37.4753221305,
          longitude: 121.4585834742
        },
        name: 'ä¸‰å…ƒæ¡¥ï¼Ÿ'
      }, {
        title: 'Puzzle 8',
        description: 'é«˜å»ºç­‘ï¼Œé«˜ç²¾ç¡®ï¼Œé«˜ç§‘æŠ€',
        location: {
          latitude: 37.4760458655,
          longitude: 121.4571404457
        },
        name: 'é’Ÿæ¥¼'
      }, {
        title: 'Puzzle 9',
        description: 'å…«æ¡è·¯',
        location: {
          latitude: 37.4771910553,
          longitude: 121.4563840628
        },
        name: 'å…«æ™¯å›­'
      }, {
        title: 'Puzzle 10',
        description: 'æ¨ªçœ‰å†·å¯¹åƒå¤«æŒ‡ï¼Œ',
        location: {
          latitude: 37.4751433243,
          longitude: 121.4547747374
        },
        name: 'å­ºå­ç‰›'
      }, {
        title: 'Puzzle 11',
        description: 'å‘½è¿çš„äº¤å‰ç‚¹',
        location: {
          latitude: 37.4750922367,
          longitude: 121.4536750317
        },
        name: 'åå­—è·¯å£'
      }, ],
      PI: 3.1415926,
      EARTH_RADIUS: 6378137.0,
      distance: 99999,
      maxDiff: 300,
      wrongCount: 0,
      showWrong: false
    },
    methods: {
      imHere() {
        wx.getLocation({
          type: 'gcj02',
          success: res => {
            this.location = res
            this.distance = this.getGreatCircleDistance(res.latitude, res.longitude, this.puzzleList[this.nowStatus - 1].location.latitude, this.puzzleList[this.nowStatus - 1].location.longitude)
            if (this.distance < this.maxDiff) {
              if (this.nowStatus < this.puzzleList.length) {
                wx.showModal({
                  title: 'æ­å–œ',
                  content: `å°±æ˜¯è¿™é‡Œï¼š${this.puzzleList[this.nowStatus - 1].name}ï¼Œå…ˆçœ‹ç¾æ™¯å†å»ä¸‹ä¸€å…³å§ï¼`,
                  showCancel: false,
                  success: res => {
                    if (res.confirm) {
                      this.nowStatus += 1
                      wx.setStorageSync('status', this.nowStatus)
                    }
                  }
                })
              } else {
                wx.showModal({
                  title: 'æ­å–œ',
                  content: 'ä½ å·²ç»å®Œæˆæ¸¸è§ˆäº†ï¼Œå¿«å»é¢†å–ä½ çš„å¥–å“å§ï¼',
                  showCancel: false,
                  success: res => {
                    if (res.confirm) {
                      wx.redirectTo({
                        url: 'mail'
                      })
                    }
                  }
                })
              }
            } else {
              wx.showToast({
                icon: 'none',
                title: 'ä¸æ˜¯è¿™é‡Œå“¦',
                duration: 2500
              })
              this.wrongCount++
              if (this.wrongCount >= 5) {
                this.showWrong = true
              }
            }
            console.log(res, this.distance)
          }
        })
      },
      imWrong() {
        this.wrongCount = 0
        this.showWrong = false
        if (this.nowStatus < this.puzzleList.length) {
          wx.showModal({
            title: 'å¥½å§',
            content: `æ˜¯${this.puzzleList[this.nowStatus - 1].name}ï¼Œä½ è¯´çš„å¯¹ğŸ˜‘`,
            showCancel: false,
            success: res => {
              if (res.confirm) {
                this.nowStatus += 1
                wx.setStorageSync('status', this.nowStatus)
              }
            }
          })
        } else {
          wx.showModal({
            title: 'æ­å–œ',
            content: 'ä½ å·²ç»å®Œæˆæ¸¸è§ˆäº†ï¼Œå¿«å»é¢†å–ä½ çš„å¥–å“å§ï¼',
            showCancel: false,
            success: res => {
              if (res.confirm) {
                wx.redirectTo({
                  url: 'mail'
                })
              }
            }
          })
        }
      },
      getRad(d) {
        return d * this.PI / 180.0
      },
      getGreatCircleDistance(lat1, lng1, lat2, lng2) {
        let radLat1 = this.getRad(lat1)
        let radLat2 = this.getRad(lat2)
        let a = radLat1 - radLat2
        let b = this.getRad(lng1) - this.getRad(lng2)
        let s = 2 * Math.asin(Math.sqrt(Math.pow(Math.sin(a / 2), 2) + Math.cos(radLat1) * Math.cos(radLat2) * Math.pow(Math.sin(b / 2), 2)))
        s = s * this.EARTH_RADIUS
        s = Math.round(s * 10000) / 10000.0
        return s
      }
    },
    onLoad(e) {
      if (e.status) {
        this.nowStatus = parseInt(e.status)
        wx.setStorageSync('status', this.nowStatus)
      }
    }
  })
</script>
<config>
  {
    navigationBarTitleText: 'è°œé¢˜'
  }
</config>
<style lang="less">
  page{
    background-color: #FFFAFA;
  }
  .container{
    .title{
      font-size: 40rpx;
      margin-bottom: 40rpx;
    }
    .description{
      font-size: 30rpx;
      margin-bottom: 100rpx;
    }
  }
</style>
