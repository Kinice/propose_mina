<template>
  <div class="container">
    <div class="main" v-if="isLogin">
      <div class="item part1" :class="{'show': statusList['list1'][0]}">Hello!</div>
      <div class="item part1" :class="{'show': statusList['list1'][1]}">
        <img class="img" :src="userInfo.avatarUrl"/>
        <div>å¯çˆ±çš„ {{userInfo.nickName}}</div>
      </div>
      <div class="item part1" :class="{'show': statusList['list1'][2]}">
        æ¬¢è¿æ¥åˆ° <span class="text-olive">çƒŸé›¨ä¹‹è°œ</span>
      </div>
      <div class="item part1" v-if="!hasLocationAuth" :class="{'show': statusList['list1'][3]}">
        è¯·å…ˆç»™æˆ‘ä¸€ä¸ªæˆæƒ
      </div>
      <div class="item part1" v-if="!hasLocationAuth" :class="{'show': statusList['list1'][4]}">
        <button class="cu-btn bg-olive" @tap="getLocationAuth">æˆæƒ</button>
      </div>
      <div class="item part2" :class="{'show': statusList['list2'][0]}">
        OK ä¸‹é¢æ¥è¯´æ˜ä½¿ç”¨æ–¹æ³•
      </div>
      <div class="item part2" :class="{'show': statusList['list2'][1]}">
        æˆ‘ä¼šå…ˆç»™ä½ ä¸€ä¸ªè°œé¢˜ ç­”æ¡ˆæ˜¯ä¸€ä¸ªåœ°æ–¹
      </div>
      <div class="item part2" :class="{'show': statusList['list2'][2]}">
        èªæ˜çš„ä½ æƒ³åˆ°ç­”æ¡ˆå å°±å»é‚£ä¸ªåœ°æ–¹ ç‚¹å‡» <span class="text-olive">æˆ‘åˆ°äº†</span>
      </div>
      <div class="item part2" :class="{'show': statusList['list2'][3]}">
        æˆ‘å°±ä¼šå¸¦ä½ åˆ°ä¸‹ä¸€ä¸ªåœ°æ–¹
      </div>
      <div class="item part2" :class="{'show': statusList['list2'][4]}">
        ç”±äºå®šä½ç²¾åº¦ å¯èƒ½ä¼šä¸å¤ªå‡†ç¡®
      </div>
      <div class="item part2" :class="{'show': statusList['list2'][5]}">
        åšå®šä½ çš„æƒ³æ³• å¤šç‚¹å‡ æ¬¡ <span class="text-olive">æˆ‘åˆ°äº†</span>
      </div>
      <div class="item part2" :class="{'show': statusList['list2'][6]}">
        å½“ä½ ç­”å‡ºæœ€åä¸€ä¸ªè°œé¢˜ æœ¬æ¬¡æ¸¸è§ˆä¹Ÿåˆ°æ­¤ç»“æŸ
      </div>
      <div class="item part2" :class="{'show': statusList['list2'][7]}">åˆ«æ€¥</div>
      <div class="item part2" :class="{'show': statusList['list2'][8]}">
        ä½ è¿˜ä¼šå¾—åˆ°ä¸€ä»½<span class="text-olive">ç²¾ç¾å¤§å¥–</span>ğŸ
      </div>
      <div class="item part2" :class="{'show': statusList['list2'][9]}">
        <button class="cu-btn bg-olive" @tap="goPuzzle(1)">å‡†å¤‡å¥½äº† å°±ç‚¹è¿™é‡Œ</button>
      </div>
<!--       <button class="cu-btn bg-red margin-tb-sm lg" @tap="getLocation">è·å–åœ°ç†ä½ç½®</button>
      latitude: {{location.latitude}} <br>
      longitude: {{location.longitude}} <br>
      accuracy: {{location.accuracy}} <br>
      work latitude: {{workLocation.latitude}} <br>
      work longitude: {{workLocation.longitude}} <br>
      distance: {{distance}} -->
    </div>
    <div class="nologin" v-else>
      <div class="word">
        è¯·å…ˆç™»å½•
      </div>
      <button class="cu-btn bg-olive margin-tb-sm lg" open-type="getUserInfo" bindgetuserinfo="onGotUserInfo">ç™»å½•</button>
    </div>
  </div>
</template>
<script>
  import wepy from '@wepy/core'
  wepy.page({
    data: {
      userInfo: {
        nickName: 'ç”¨æˆ·'
      },
      isLogin: false,
      hasLocationAuth: false,
      location: {},
      workLocation: {
        latitude: 39.9859412184,
        longitude: 116.4786708355
      },
      PI: 3.1415926,
      EARTH_RADIUS: 6378137.0,
      distance: 99999,
      maxDiff: 200,
      statusList: {
        list1: {
          0: false,
          1: false,
          2: false,
          3: false,
          4: false
        },
        list2: {
          0: false,
          1: false,
          2: false,
          3: false,
          4: false,
          5: false,
          6: false,
          7: false,
          8: false,
          9: false
        }
      }
    },
    methods: {
      loginFadeIn(index) {
        for (let i in this.statusList[index]) {
          setTimeout(() => {
            this.statusList[index][i] = true
          }, (i + 1) * 160)
        }
      },
      onGotUserInfo(e) {
        if (e.$wx.detail.userInfo) {
          this.userInfo = e.$wx.detail.userInfo
          this.isLogin = true
          this.loginFadeIn('list1')
        } else {
          wx.showModal({
            title: 'æç¤º',
            content: 'éœ€è¦æˆæƒæ‰å¯ä»¥ä½¿ç”¨ï¼Œè¯·é‡æ–°æˆæƒ',
            showCancel: false,
            success: res => {
              if (res.confirm) {
                this.isLogin = false
              }
            }
          })
        }
      },
      getLocationAuth() {
        wx.authorize({
          scope: 'scope.userLocation',
          success: res => {
            this.hasLocationAuth = true
            this.loginFadeIn('list2')
          }
        })
      },
      getLocation() {
        if (!this.hasLocationAuth) return
        wx.getLocation({
          type: 'gcj02',
          success: res => {
            console.log(res)
            this.location = res
            this.distance = this.getGreatCircleDistance(res.latitude, res.longitude, this.workLocation.latitude, this.workLocation.longitude)
            wx.openLocation({
              latitude: 39.9859412184,
              longitude: 116.4786708355,
              scale: 18
            })
          }
        })
      },
      chooseLocation() {
        if (!this.hasLocationAuth) return
        wx.chooseLocation({
          success: res => {
            console.log(res)
          }
        })
      },
      getRad(d) {
        return d * this.PI / 180.0
      },
      getGreatCircleDistance(lat1, lng1, lat2, lng2) {
        let radLat1 = this.getRad(lat1)
        let radLat2 = this.getRad(lat2)
        let a = radLat1 - radLat2
        let b = this.getRad(lng1) - this.getRad(lng2)
        let s = 2 * Math.asin(Math.sqrt(Math.pow(Math.sin(a / 2), 2) + Math.cos(radLat1) * Math.cos(radLat2) * Math.pow(Math.sin(b / 2), 2)))
        s = s * this.EARTH_RADIUS
        s = Math.round(s * 10000) / 10000.0
        return s
      },
      goPuzzle(status) {
        wx.redirectTo({
          url: `puzzle?status=${status}`
        })
      }
    },
    created() {
      wx.getSetting({
        success: res => {
          if (res.authSetting['scope.userInfo']) {
            wx.getUserInfo({
              success: res => {
                this.userInfo = res.userInfo
                this.isLogin = true
                this.loginFadeIn('list1')
              }
            })
          }
          if (res.authSetting['scope.userLocation']) {
            this.hasLocationAuth = true
          }
        }
      })
      let status = wx.getStorageSync('status')
      if (status) {
        this.goPuzzle(status)
      }
    }
  })
</script>
<config>
  {
    navigationBarTitleText: 'çƒŸé›¨ä¹‹è°œ'
  }
</config>
<style lang="less">
  page{
    background-color: #FFFAFA;
  }
  .container{
    .nologin{
      text-align: center;
      padding-top: 200rpx;
      .word{
        font-size: 36rpx;
        margin-bottom: 30rpx;
      }
    }
    .main{
      text-align: center;
      padding-top: 20rpx;
      .item{
        font-size: 32rpx;
        margin-bottom: 30rpx;
        opacity: 0;
        transition: opacity .4s linear;
        .img{
          width: 100rpx;
          height: 100rpx;
          border-radius: 50%;
        }
      }
      .show{
        opacity: 1;
      }
    }
  }
</style>
